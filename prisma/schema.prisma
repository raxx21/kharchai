// Budget App Database Schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Model
model User {
  id            String         @id @default(uuid())
  email         String         @unique
  passwordHash  String         @map("password_hash")
  name          String?
  preferences   Json?          // currency, timezone, etc.
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  // Relations
  banks         Bank[]
  categories    Category[]
  labels        Label[]
  transactions  Transaction[]
  budgets       Budget[]
  bills         Bill[]
  chatMessages  ChatMessage[]
  insights      Insight[]

  @@map("users")
}

// Bank/Financial Institution Model
model Bank {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  name      String
  type      BankType // bank, credit_card, wallet
  color     String?
  icon      String?
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  creditCard   CreditCard?
  transactions Transaction[]
  bills        Bill[]

  @@map("banks")
}

enum BankType {
  BANK
  CREDIT_CARD
  WALLET
}

// Credit Card Model
model CreditCard {
  id                    String   @id @default(uuid())
  bankId                String   @unique @map("bank_id")
  cardName              String   @map("card_name")
  lastFourDigits        String?  @map("last_four_digits")
  billingCycleStartDate Int      @map("billing_cycle_start_date") // 1-31
  billingCycleEndDate   Int      @map("billing_cycle_end_date")   // 1-31
  paymentDueDay         Int      @map("payment_due_day")          // 1-31
  creditLimit           Decimal? @map("credit_limit") @db.Decimal(12, 2)
  currentBalance        Decimal  @default(0) @map("current_balance") @db.Decimal(12, 2)
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  // Relations
  bank           Bank            @relation(fields: [bankId], references: [id], onDelete: Cascade)
  billingCycles  BillingCycle[]

  @@map("credit_cards")
}

// Category Model
model Category {
  id               String   @id @default(uuid())
  userId           String?  @map("user_id") // null for system categories
  name             String
  icon             String?
  color            String?
  parentCategoryId String?  @map("parent_category_id")
  isSystem         Boolean  @default(false) @map("is_system")
  createdAt        DateTime @default(now()) @map("created_at")

  // Relations
  user         User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent       Category?     @relation("CategoryHierarchy", fields: [parentCategoryId], references: [id])
  children     Category[]    @relation("CategoryHierarchy")
  transactions Transaction[]
  budgets      Budget[]
  bills        Bill[]

  @@map("categories")
}

// Label/Tag Model
model Label {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  name      String
  color     String?
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user                User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactionLabels   TransactionLabel[]

  @@map("labels")
}

// Transaction Model
model Transaction {
  id              String          @id @default(uuid())
  userId          String          @map("user_id")
  bankId          String          @map("bank_id")
  amount          Decimal         @db.Decimal(12, 2)
  currency        String          @default("USD")
  type            TransactionType
  categoryId      String          @map("category_id")
  description     String
  transactionDate DateTime        @map("transaction_date")
  notes           String?
  receiptUrl      String?         @map("receipt_url")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  // Relations
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  bank        Bank             @relation(fields: [bankId], references: [id], onDelete: Cascade)
  category    Category         @relation(fields: [categoryId], references: [id])
  labels      TransactionLabel[]
  billPayment BillPayment?

  @@map("transactions")
}

enum TransactionType {
  INCOME
  EXPENSE
  TRANSFER
}

// Transaction Labels (Many-to-Many)
model TransactionLabel {
  transactionId String @map("transaction_id")
  labelId       String @map("label_id")

  // Relations
  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  label       Label       @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@id([transactionId, labelId])
  @@map("transaction_labels")
}

// Budget Model
model Budget {
  id         String       @id @default(uuid())
  userId     String       @map("user_id")
  categoryId String       @map("category_id")
  amount     Decimal      @db.Decimal(12, 2)
  period     BudgetPeriod
  startDate  DateTime     @map("start_date")
  endDate    DateTime?    @map("end_date")
  createdAt  DateTime     @default(now()) @map("created_at")
  updatedAt  DateTime     @updatedAt @map("updated_at")

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id])

  @@map("budgets")
}

enum BudgetPeriod {
  WEEKLY
  MONTHLY
  YEARLY
}

// Billing Cycle Model
model BillingCycle {
  id             String      @id @default(uuid())
  creditCardId   String      @map("credit_card_id")
  cycleStartDate DateTime    @map("cycle_start_date")
  cycleEndDate   DateTime    @map("cycle_end_date")
  dueDate        DateTime    @map("due_date")
  totalAmount    Decimal     @default(0) @map("total_amount") @db.Decimal(12, 2)
  isPaid         Boolean     @default(false) @map("is_paid")
  paidDate       DateTime?   @map("paid_date")
  createdAt      DateTime    @default(now()) @map("created_at")

  // Relations
  creditCard CreditCard @relation(fields: [creditCardId], references: [id], onDelete: Cascade)

  @@map("billing_cycles")
}

// AI Chat Message Model
model ChatMessage {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  role        String   // "user" or "assistant"
  content     String   @db.Text
  contextData Json?    @map("context_data") // relevant expense data at time of chat
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("chat_messages")
}

// AI-Generated Insights Model
model Insight {
  id          String       @id @default(uuid())
  userId      String       @map("user_id")
  type        InsightType
  title       String
  description String       @db.Text
  data        Json?
  isRead      Boolean      @default(false) @map("is_read")
  createdAt   DateTime     @default(now()) @map("created_at")
  expiresAt   DateTime?    @map("expires_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("insights")
}

enum InsightType {
  SPENDING_PATTERN
  BUDGET_ALERT
  SAVINGS_OPPORTUNITY
  UNUSUAL_SPENDING
  BILL_REMINDER
  BILL_OVERDUE
}

// Bill Management Enums
enum BillType {
  UTILITIES
  SUBSCRIPTION
  RENT_MORTGAGE
  INSURANCE
  OTHER
}

enum BillRecurrence {
  ONE_TIME
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  SEMI_ANNUAL
  ANNUAL
}

enum BillStatus {
  UPCOMING
  DUE_SOON
  OVERDUE
  PAID
  CANCELLED
}

// Bill Model
model Bill {
  id                String          @id @default(uuid())
  userId            String          @map("user_id")
  name              String
  description       String?
  billType          BillType        @map("bill_type")
  amount            Decimal         @db.Decimal(12, 2)
  categoryId        String          @map("category_id")

  recurrence        BillRecurrence
  startDate         DateTime        @map("start_date")
  endDate           DateTime?       @map("end_date")
  dayOfMonth        Int?            @map("day_of_month")
  dayOfWeek         Int?            @map("day_of_week")

  reminderDaysBefore Int           @default(3) @map("reminder_days_before")
  autoPay           Boolean         @default(false) @map("auto_pay")
  bankId            String?         @map("bank_id")

  notes             String?
  isActive          Boolean         @default(true) @map("is_active")
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")

  // Relations
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  category          Category        @relation(fields: [categoryId], references: [id])
  bank              Bank?           @relation(fields: [bankId], references: [id])
  payments          BillPayment[]

  @@map("bills")
}

// Bill Payment Model
model BillPayment {
  id              String       @id @default(uuid())
  billId          String       @map("bill_id")
  dueDate         DateTime     @map("due_date")
  amount          Decimal      @db.Decimal(12, 2)
  status          BillStatus   @default(UPCOMING)

  paidDate        DateTime?    @map("paid_date")
  paidAmount      Decimal?     @map("paid_amount") @db.Decimal(12, 2)
  transactionId   String?      @unique @map("transaction_id")

  reminderSent    Boolean      @default(false) @map("reminder_sent")
  reminderSentAt  DateTime?    @map("reminder_sent_at")

  notes           String?
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  // Relations
  bill            Bill         @relation(fields: [billId], references: [id], onDelete: Cascade)
  transaction     Transaction? @relation(fields: [transactionId], references: [id])

  @@map("bill_payments")
}
